version: '3.9'

###
# Some repeated defaults:
# tmpfs and /sys/fs/cgroup volumes are needed for systemd to work properly
# /mnt/build is where the git repositories will be shared with the host
###
x-build-args:
  &default-build-args
  OSimage: "$OSimage"
  REPO: "$REPO"
  useproxy: "${useproxy:-without}"
  proxy: "${proxy:-}"

x-tmpfs:
  &default-tmpfs
  - /run
  - /run/lock
  - /tmp

x-volumes:
  &default-volumes
  - ..:/mnt/build

###
# The first service is only to build the required images
# and to build the source package
###
services:
  deb_build:
    container_name: source-build
    platform: "linux/amd64"
    image: docker.io/ntw0n/psbuild.$REPO.$OSimage@sha256:531ec6c546ddd4bd02f8b0c386b15696a1f20dd5356dd84a19cbbbbd7c8f7073
    privileged: true
    tmpfs: *default-tmpfs
    volumes: *default-volumes

###
# The binary build containers
###
  amd64_build:
    container_name: amd64-build
    platform: "linux/amd64"
    image: docker.io/ntw0n/psbuild.$REPO.$OSimage@sha256:531ec6c546ddd4bd02f8b0c386b15696a1f20dd5356dd84a19cbbbbd7c8f7073
    privileged: true
    tmpfs: *default-tmpfs
    volumes: *default-volumes

  arm64_build:
    container_name: arm64-build
    platform: "linux/arm64"
    image: docker.io/ntw0n/psbuild.$REPO.$OSimage@sha256:da6a54aa92dbddca188ac3c918333645e0d677eab772f6ce665e8bb08d5d56cc
    privileged: true
    tmpfs: *default-tmpfs
    volumes: *default-volumes

  armv7_build:
    container_name: armv7-build
    platform: "linux/arm/v7"
    image: docker.io/ntw0n/psbuild.$REPO.$OSimage@sha256:d224f0ead2caa9c96540dfd9776856c2be00a74b559d32d652a4f33bd1ad71e4
    privileged: true
    tmpfs: *default-tmpfs
    volumes: *default-volumes

  ppc64le_build:
    container_name: ppc64le-build
    platform: "linux/ppc64le"
    image: docker.io/ntw0n/psbuild.$REPO.$OSimage@sha256:94d7ba72b2acfe15a7ba04cca9ff4ea9cad9feff329e1cc906e88372bd8d7ed3
    privileged: true
    tmpfs: *default-tmpfs
    volumes: *default-volumes

###
# The testing containers
###
  deb_test:
    container_name: install-test
    build:
      context: .
      target: test-image
      args: *default-build-args
    platform: "linux/amd64"
    image: docker.io/ntw0n/install.$REPO.$OSimage
    privileged: true
    tmpfs: *default-tmpfs
    volumes: *default-volumes

  amd64_test:
    container_name: amd64-test
    platform: "linux/amd64"
    image: docker.io/ntw0n/install.$REPO.$OSimage
    privileged: true
    tmpfs: *default-tmpfs
    volumes: *default-volumes

  arm64_test:
    container_name: arm64-test
    platform: "linux/arm64"
    image: docker.io/ntw0n/install.$REPO.$OSimage
    privileged: true
    tmpfs: *default-tmpfs
    volumes: *default-volumes

  armv7_test:
    container_name: armv7-test
    platform: "linux/arm/v7"
    image: docker.io/ntw0n/install.$REPO.$OSimage
    privileged: true
    tmpfs: *default-tmpfs
    volumes: *default-volumes

  ppc64le_test:
    container_name: ppc64le-test
    platform: "linux/ppc64le"
    image: docker.io/ntw0n/install.$REPO.$OSimage
    privileged: true
    tmpfs: *default-tmpfs
    volumes: *default-volumes

